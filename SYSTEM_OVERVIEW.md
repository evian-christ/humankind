# SYSTEM_OVERVIEW.md

게임 시스템의 현재 구현 상태와 단기 로드맵을 정리한 문서입니다. 온보딩/규칙은 `README.md`, 장기 아이디어는 `DESIGN_REFERENCE.md`를 참고하세요.

## 1. 현재 빌드 스냅샷
- 기본 루프 완성: Spin → 랜덤 배치 → 전투 → 심볼 효과 → 선택 페이즈 → 식량 지불 체크.
- 5×4 보드, 최대 20개 심볼 동시 배치, 8방향 인접 판정.
- 리소스: 식량(생존 비용), 골드(UI 표시 및 일부 심볼 효과), 경험치/레벨(희귀도 가중치에 사용).
- 37개 `.tres` 심볼 리소스 (농업, 산업, 종교, 전투, 정착지, 탐험, 경제, 숲).
- 전투 단계 구현: 플레이어 Combat 심볼이 인접 Enemy 심볼 HP를 깎고, 소진 시 파괴.
- 실시간 비주얼: 슬롯 하이라이트, 플로팅 텍스트, 카운터 오버레이, 파괴 연출.
- 승리 조건: AGI(ID 28) 심볼이 보드에 등장하면 즉시 승리 처리.

## 2. 핵심 루프 & 자원 흐름
1. **Spin**: 플레이어 보유 심볼을 셔플해 메인 슬롯(5×4)에 배치하고, 동시에 서브 슬롯(1×3)도 회전하여 환경 심볼 카운터를 감소.
2. **Combat Phase**: `SymbolEffectsProcessor.process_combat()`가 Combat·Enemy 상호작용을 처리.
3. **Effects Phase**: 각 심볼의 패시브/특수 효과 계산, 파괴 플래그 처리, 자원 UI 업데이트.
4. **Selection Phase**: 레벨 기반 희귀도 가중치로 3개의 심볼을 제시하고 플레이어가 1개 선택.
5. **Relic Phase** *(레벨업 시)*: 심볼 선택 직후 유물 1개를 선택. 유물은 영구 패시브로 플레이스타일을 규정.
6. **Upkeep**: 매 10턴마다 식량 비용 지불(100 → 150 → 200 → ... +50씩 증가). 지불 실패 시 게임 오버.

자원 요약:
- **Food**: 기본 생존 자원. 모든 심볼이 합산된 값을 플로팅 텍스트로 단일 표시.
- **Gold**: Sheep/Taxation/Merchant/Guild 등 경제 심볼이 생산. UI에 즉시 반영, 사용처는 확장 예정.
- **EXP/Level**: 턴당 +1, 라이브러리/종교 등 추가 획득. 레벨별 희귀도 가중치는 `GameStateManager.get_symbol_probabilities()` 참고.

## 3. 심볼 카테고리
| 카테고리 | 대표 심볼 | 특징 |
| --- | --- | --- |
| 농업/기본 식량 | Wheat, Rice, Banana, Cow, Sheep | 카운터 기반 주기/배치 보너스, 골드 생성(Sheep) |
| 산업/파괴 | Mine, Coal, Industrial Revolution, Revolution | 자원 생성·파괴, 무작위 심볼 보상 |
| 종교 | Ritual, Protestantism, Buddhism, Hinduism, Islam, Temple | 인접 종교 페널티, 빈칸/격리 보너스, 경험치 연계 |
| 탐험 | Sail, Compass | 상호 카운트 후 파괴, 고정 식량 보상 |
| 전투(플레이어) | Warrior~Infantry | 공격력/공격 횟수 정의, 승리 시 적 제거 |
| 적 심볼 | Barbarian | HP 기반 방해 요소, 전투 없으면 슬롯 점유 |
| 정착지 진화 | Campfire → Town → City | 턴 카운터 기반 진화, 음식 생산 주기 |
| 경제 | Wine, Taxation, Merchant, Guild | 식량 페널티 대신 골드/EXP 등 보상 |
| 숲 시스템 | Forest, Forest Clearing | 파괴 보너스·연계 파괴 |
| 환경/서브 슬롯 | Barbarian Invasion, 자연재해, 황금기 등 | 서브 슬롯 전용. 카운터가 0이 되면 메인 슬롯/게임 상태에 이벤트 트리거 |

모든 심볼 정의는 `humankind-in-a-nutshell/data/symbols/*.tres`에서 관리하며, `SymbolData`가 런타임 로딩합니다.

## 4. 서브 슬롯(환경 슬롯)
- 크기: 1×3. 메인 슬롯과 동시에 회전하지만 직접 심볼을 추가하지 않고 환경 이벤트를 준비하는 트랙.
- **카운터 기반 진행**: 각 환경 심볼은 시작 카운트를 가지며, Spin 시 해당 심볼이 서브 슬롯에 나타나면 카운터가 1 감소. 0이 되면 파괴되며 정의된 이벤트가 발동.
  - 예: *Barbarian Invasion* – 초기 카운트 20, 0이 되면 메인 슬롯에 Barbarian Enemy 심볼을 자동 생성.
- **생성 방식**: 시대/레벨 조건에 따라 자동으로 추가되며, 플레이어가 직접 구매하는 경우는 드묾. 특정 유물/이벤트가 특수 환경 심볼을 삽입할 수도 있음.
- **역할**: 메인 슬롯이 직접적인 식량/전투 플레이를 담당하는 반면, 서브 슬롯은 적 침략·자연재해·황금기 등 세계 상태 변화를 예고하고, 플레이 흐름에 장기 전략 요소를 부여.

## 5. 유물 시스템
- **획득 타이밍**: 레벨업 시 심볼 선택 직후 자동으로 유물 선택 페이즈가 열리며, 한 번에 1개 선택.
- **효과**: 영구 패시브. 식량 증폭, 서브 슬롯 조작, 특정 심볼 강화 등 덱 방향성을 규정.
- **희귀도**: 심볼 시대와 별개인 독립 희귀도 체계를 사용(예: Common/Rare/Epic/Legendary). 시대 진척과 무관하게 희귀도만 효과 강도를 나타냄.
- **풀 구성**: 기본 풀 + 시대/레벨 조건 충족 시 해금되는 특수 유물 + 특정 이벤트/서브 슬롯 결과로 등장하는 유물.

## 6. 전투 및 파괴 처리
- Combat 심볼은 `attack_power`, `remaining_attacks`를 사용하며, Enemy 심볼(`symbol_type == ENEMY`)의 `enemy_hp`를 감소시킵니다.
- 공격이 완료되면 `is_marked_for_destruction`을 통해 Combat/Enemy 모두 파괴 큐에 올라가고, `GameController`가 보드와 플레이어 컬렉션에서 제거합니다.
- Fish, Sail, Compass, Forest 등 특수 심볼은 파괴 시 고정 보상을 즉시 지급하고 슬롯을 비웁니다.

## 7. UI & 표시 요소
- Top/Bottom Bar에 식량·골드·레벨·EXP·턴/시대/지불 타이머 표시.
- 보드 배경(`slot_bg.png`)과 심볼 아이콘은 `assets/sprites/`에서 관리.
- 선택 UI는 `SymbolSelectionManager`가 오버레이를 생성하며, 추후 스킵/상점 등 확장 예정.

## 8. 남은 과제 (요약)
| 우선순위 | 작업 | 메모 |
| --- | --- | --- |
| 높음 | 골드 사용처 및 상점/재선택 시스템 | 백엔드 골드만 존재, 소비 루프 미완 |
| 높음 | 승리/패배 연출 강화 | 현재 텍스트/버튼 상태만 변경 |
| 높음 | 세이브/로드 시스템 | 장기 러닝 필요 |
| 중간 | 튜토리얼/도움말 UI | 신규 플레이어 온보딩 |
| 중간 | 밸런싱 & 테스트 | 전투/종교 페널티 수치 조정 |
| 중간 | 메타 진행 (난이도, 통계, 도감) | DESIGN_REFERENCE의 장기 목표와 연동 |

### 단기 체크리스트
- [ ] 골드 전용 상호작용(상점/심볼 재롤) 설계
- [ ] 승리/게임오버 화면 시각화
- [ ] 세이브 슬롯 및 옵션 메뉴 기본 구조
- [ ] 탐험/전투 심볼 밸런스 패스
- [ ] 문서 자동화(심볼 리소스 → 문서/CSV 생성)
- [ ] 서브 슬롯 UI/로직 구체화 및 환경 심볼 풀 확장
- [ ] 유물 희귀도 체계 및 풀 구성

필요 시 이 문서에 작업 결과를 지속적으로 반영하고, 디자인 실험/아이디어는 `DESIGN_REFERENCE.md`에 기록하세요.
